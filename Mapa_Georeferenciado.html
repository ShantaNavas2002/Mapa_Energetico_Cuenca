<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/styles-panel.css">
        
        <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        </style>
        <title></title>
    </head>
    <body>
    
    <header class="main-header">
      

      <div class="header-center">
        <img src="images/UI_LogoCuencaSolar.svg" alt="Logo Central">
      </div>
      <div class="header-right">
        <img src="images/logoConsiso.svg" alt="Logo Derecha">
      </div>
    </header>
<!-- Buscador por CLAVE -->

    
        <div id="map">
          <div class="Buscador-Predio" >
            <input id="claveSearch" type="search" placeholder="Buscar por CLAVE CATASTRAL…" list="claveOptions">
            <datalist id="claveOptions"></datalist>
            <button id="claveGo" >Buscar</button>
          </div>
        </div>
        
        <div id="featurePanel" class="ui-panel hidden" role="dialog" aria-label="Ficha de predio">
        <button class="ui-close" id="panelCloseBtn" aria-label="Cerrar">×</button>
        <div id="featurePanelContent"></div>
        </div>

        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>  
        <script src="data/TOTORACOCHA_1.js"></script>
        <script src="data/PRIMERODEMAYO_2.js"></script>
        <script src="data/ORDOEZLASO_3.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
        <script src="js/menu.js" ></script>

        <script>
        var highlightLayer;
        function highlightFeature(e) {
            if (__selectedLayer === e.target) return;
            highlightLayer = e.target;

            if (e.target.feature.geometry.type === 'LineString' || e.target.feature.geometry.type === 'MultiLineString') {
            highlightLayer.setStyle({
                color: '#ffff00',
            });
            } else {
            highlightLayer.setStyle({
                fillColor: 'rgba(98, 119, 112)',
                fillOpacity: 1
            });
            }
        }
        var map = L.map('map', {
        zoomControl:false, maxZoom:28, minZoom:14
        }).fitBounds([[-2.908626027397235,-79.04784062706698],[-2.8875146284421516,-79.01489480969526]]);
        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
        
        var zoomControl = L.control.zoom({
            position: 'topleft'
        }).addTo(map);
        var bounds_group = new L.featureGroup([]);
        
        map.createPane('pane_Positronretina_0');
        map.getPane('pane_Positronretina_0').style.zIndex = 400;
        var layer_Positronretina_0 = L.tileLayer('https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png', {
            pane: 'pane_Positronretina_0',
            opacity: 1.0,
            attribution: '<a href="https://cartodb.com/basemaps/">Map tiles by CartoDB, under CC BY 3.0. Data by OpenStreetMap, under ODbL.</a>',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 5,
            maxNativeZoom: 20
        });
        layer_Positronretina_0;
        map.addLayer(layer_Positronretina_0);

        var __selectedLayer = null;

// Devuelve  elementos SVG del layer 
function getLayerElements(layer){
  var el = (typeof layer.getElement === 'function') ? layer.getElement() : layer._path;
  if (!el) return [];
  if (el.tagName && el.tagName.toLowerCase() === 'g') {
    return Array.from(el.querySelectorAll('path.leaflet-interactive'));
  }
  return [el];
}

function markSelected(layer){

  if (typeof layer.bringToFront === 'function') layer.bringToFront();

  if (typeof layer.setStyle === 'function') {
    layer.setStyle({ weight: 3, color: '#2563eb', fillOpacity: 0.85 });
  }
  getLayerElements(layer).forEach(function(p){ if (p) p.classList.add('feature-selected'); });
}

function unmarkSelected(layer){
  if (!layer) return;
  // Reset de estilo de la capa padre 
  for (var i in layer._eventParents) {
    if (typeof layer._eventParents[i].resetStyle === 'function') {
      layer._eventParents[i].resetStyle(layer);
    }
  }
  getLayerElements(layer).forEach(function(p){ if (p) p.classList.remove('feature-selected'); });
}

function selectLayer(layer){
  if (__selectedLayer && __selectedLayer !== layer) {
    unmarkSelected(__selectedLayer);
  }
  __selectedLayer = layer;
  markSelected(layer);
}

// Cerrar panel 
function closeFeaturePanel(){
  var panel = document.getElementById('featurePanel');
  if (panel) panel.classList.add('hidden');
  if (__selectedLayer) {
    unmarkSelected(__selectedLayer);
    __selectedLayer = null;
  }
}

// Conecta tecla ESC una sola vez
(function wireCloseOnce(){
  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('panelCloseBtn');
    if (btn && !btn._wired){
      btn._wired = true;
      btn.addEventListener('click', closeFeaturePanel);
      document.addEventListener('keydown', function(ev){
        if (ev.key === 'Escape') closeFeaturePanel();
      });
    }
  });
})();

// =============================================================================
//  LÓGICA 


var currentChart = null; // Una sola variable 
var currentChartStart = 0; 

function getChartData(props) {
    return [
        {label:'Enero',     sum:'SUM_C_ENER', emax:'E_M_ENE',  erec:'E_R_ENE'},
        {label:'Febrero',   sum:'SUM_C_FEBR', emax:'E_M_FEB',  erec:'E_R_FEB'},
        {label:'Marzo',     sum:'SUM_C_MARZ', emax:'E_M_MAR',  erec:'E_R_MAR'},
        {label:'Abril',     sum:'SUM_C_ABRI', emax:'E_M_ABR',  erec:'E_R_ABR'},
        {label:'Mayo',      sum:'SUM_C_MAYO', emax:'E_M_MAY',  erec:'E_R_MAY'},
        {label:'Junio',     sum:'SUM_C_JUNI', emax:'E_M_JUN',  erec:'E_R_JUN'},
        {label:'Julio',     sum:'SUM_C_JULI', emax:'E_M_JUL',  erec:'E_R_JUL'},
        {label:'Agosto',    sum:'SUM_C_AGOS', emax:'E_M_AGO',  erec:'E_R_AGO'},
        {label:'Septiembre',sum:'SUM_C_SEP',  emax:'E_M_SEP',  erec:'E_R_SEP'},
        {label:'Octubre',   sum:'SUM_C_OCTU', emax:'E_M_OCT',  erec:'E_R_OCT'},
        {label:'Noviembre', sum:'SUM_C_NOVI', emax:'E_M_NOV',  erec:'E_R_NOV'},
        {label:'Diciembre', sum:'SUM_C_DIC',  emax:'E_M_DIC',  erec:'E_R_DIC'}
    ].map(m => ({
        label: m.label,
        sum : Number(props[m.sum]  ?? 0),
        emax: Number(props[m.emax] ?? 0),
        erec: Number(props[m.erec] ?? 0)
    }));
}

// Renderiza el gráfico en el Canvas
function renderSharedChart(allData, startIndex) {
    var ctx = document.getElementById('energyChart');
    if (!ctx) return;

    if (currentChart) { currentChart.destroy(); }

    // Tomamos solo 2 meses
    var sliceData = allData.slice(startIndex, startIndex + 2);
    var labels = sliceData.map(d => d.label);

    currentChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                { label: 'Consumo', data: sliceData.map(d => d.sum), backgroundColor: '#D9D9D9', borderColor: '#585859', borderWidth: 1 },              
                { label: 'Energía recomendada', data: sliceData.map(d => d.erec), backgroundColor: '#FDAA76', borderColor: '#FF9C60', borderWidth: 1 },
                { label: 'Energía máxima', data: sliceData.map(d => d.emax), backgroundColor: '#BCD1AC', borderColor: "#B0CC66 ",  borderWidth: 1 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: { 
                legend: { position: 'top' }, 
                tooltip: { enabled: true } 
            },
            scales: { 
                x: { ticks: { autoSkip: false } }, 
                y: { 
                    beginAtZero: true,
                    
                    title: {
                        display: true,
                        text: 'kWh',      
                        font: {
                            
                            size: 14
                        },
                        padding: {bottom: 10} 
                    }
                    
                } 
            }
        }
    });

    // Actualizar etiqueta de texto
    var rangeLabel = document.getElementById('chartRangeLabel');
    if (rangeLabel) rangeLabel.textContent = labels.join(' – ');
}

// Inicializa la lógica del gráfico 
function initChart(feature) {
    var allData = getChartData(feature.properties || {});
    currentChartStart = 0; 
    renderSharedChart(allData, currentChartStart);

    
    var prevBtn = document.getElementById('chartPrev');
    var nextBtn = document.getElementById('chartNext');

    if (prevBtn) prevBtn.onclick = function() {
        currentChartStart = Math.max(0, currentChartStart - 2);
        renderSharedChart(allData, currentChartStart);
    };
    if (nextBtn) nextBtn.onclick = function() {
        currentChartStart = Math.min(10, currentChartStart + 2);
        renderSharedChart(allData, currentChartStart);
    };
}

// =============================================================================
// CONSTRUCTOR HTML DEL PANEL CON LÓGICA CONDICIONAL
// =============================================================================

function buildPanelContent(feature, sectorTitle) {
    var p = feature.properties;
    
    // Función helper para valores
    function val(k) { 
        return (p[k] !== null && p[k] !== undefined) ? String(p[k]) : '-'; 
    }

    // ========================================================================
    // VERIFICACIÓN DE CONDICIONES ESPECIALES
    // ========================================================================
    
    // Si X_1 o X_2 es igual a 1, mostrar panel alternativo 1
    if (p.X_1 == 1 || p.X_2 == 1) {
        return `
        <div class="popup-card">
          <div class="popup-title">
            <span class="key mono">Clave Catastral:</span>
            <strong>${val('CLAVE')}</strong>
          </div>
          
          <div class="alert-panel">
            <div class= "panel1">
              <h3>Datos Insuficientes</h3>
            </div>
          </div>
        </div>`;
    }
    
    // Si X_3 es igual a 1, mostrar panel alternativo 2
    if (p.X_3 == 1) {
        return `
        <div class="popup-card">
          <div class="popup-title">
            <span class="key mono">Clave Catastral:</span>
            <strong>${val('CLAVE')}</strong>
          </div>
          
           <div class="alert-panel">
            <div class= "panel2">
              <h3>Los paneles solare no pueden proveer la energia suficiente</h3>
            </div>
          </div>
        </div>`;
    }

    // ========================================================================
    // PANEL NORMAL (cuando no se cumplen las condiciones especiales)
    // ========================================================================
    
    function solarCard(imgSrc, label, key, suffix) {
        var valor = val(key);
        if (suffix && valor !== '-') valor += ' ' + suffix;

        return `
        <div class="solar-card">
            <div class="solar-icon">
                <img src="${imgSrc}" alt="icono" style="width:100%; height:100%; object-fit:contain;">
            </div>
            <div class="solar-info">
                <span class="solar-label">${label}</span>
                <span class="solar-value-box">${valor}</span>
            </div>
        </div>`;
    }

    return `
    <div class="popup-card">
      <div class="popup-title">
        <span class="key mono">Clave Catastral:</span>
        <strong>${val('CLAVE')}</strong>
      </div>

      <details class="section" data-section="datos" open>
        <summary>
            <div class="summary-content">
                <span>Implementacion de paneles solares Sistemas On-Grid (Sin bateria)</span>
                <img src="images/UI_Pestaña1.svg" class="header-img" alt="Sin batería">
            </div>
            <span class="chev">▾</span>
        </summary>
        
        <div class="section-body">
          <div class="solar-grid">
            ${solarCard('images/UI_panel1.svg', 'Número de paneles recomendado según su consumo eléctrico:', 'RES_01', '')}
            ${solarCard('images/UI_Inversion2.svg', 'Inversión:', 'RES_02', '$')}
            ${solarCard('images/UI_RecuInversion3.svg', 'Tiempo de recuperación de la inversión:', 'RES_03', 'años')}
            ${solarCard('images/UI_Ahorro4.svg', 'Ahorro anual posterior a la inversión:', 'RES_04', '$')}
          </div>
        </div>
      </details>

      <details class="section" data-section="bateria">
        <summary>
            <div class="summary-content">
                <span>Implementacion de paneles solares Sistemas Off-Grid (Con bateria)</span>
                <img src="images/UI_Pestaña2.svg" class="header-img" alt="Con batería">
            </div>
            <span class="chev">▾</span>
        </summary>

        <div class="section-body">
          <div class="solar-grid">
            ${solarCard('images/UI_panel1.svg', 'Número de paneles recomendado según su consumo eléctrico:', 'RES_05', '')}
            ${solarCard('images/UI_Inversion2.svg', 'Inversión:', 'RES_06', '$')}
            ${solarCard('images/UI_RecuInversion3.svg', 'Tiempo de recuperación de la inversión', 'RES_07', 'años')}
            ${solarCard('images/UI_Ahorro4.svg', 'Ahorro anual posterior a la inversión:', 'RES_08', '$')}
          </div>
        </div>
      </details>
      
      <details class="section" data-section="grafico" open>
        <summary>
          <div class="summary-content">
            <span>Análisis energético mensual</span>
            <img src="images/UI_Pestaña3.svg" class="header-img" alt="Icono de barras">
          </div>
          <span class="chev">▾</span>
        </summary>
        <div class="section-body">
          <div id="chartControls" style="display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:8px">
            <button id="chartPrev" type="button">◄</button>
            <div id="chartRangeLabel" class="mono">...</div>
            <button id="chartNext" type="button">►</button>
          </div>
          <div style="height:260px"><canvas id="energyChart"></canvas></div>
        </div>
      </details>
    </div>`;
}

// =============================================================================
//  generar Graficos (Paneles etc)

function crearGestorCapa(tituloSector) {
    return function(feature, layer) {
        
        layer.on({
            mouseout: function(e) {
                for (var i in e.target._eventParents) {
                    if (typeof e.target._eventParents[i].resetStyle === 'function') {
                        e.target._eventParents[i].resetStyle(e.target);
                    }
                }
                if (__selectedLayer === e.target) markSelected(e.target);
            },
            mouseover: highlightFeature,
        });

        // 2. Clic
        layer.on('click', function() {
            selectLayer(layer);
            
            
            var html = buildPanelContent(feature, tituloSector);
            
            
            var panel = document.getElementById('featurePanel');
            var content = document.getElementById('featurePanelContent');
            content.innerHTML = html;
            panel.classList.remove('hidden');

            
            var groups = panel.querySelectorAll('details.section');
            groups.forEach(function(d){
                d.addEventListener('toggle', function(){
                    if (d.open) groups.forEach(o => { if (o!==d) o.removeAttribute('open'); });
                    var chev = d.querySelector('.chev');
                    if (chev) chev.style.transform = d.open ? 'rotate(180deg)' : 'rotate(0deg)';
                });
            });

           
            setTimeout(function() { initChart(feature); }, 50);
        });
    };
}

// =============================================================================
// 4. DEFINICIÓN DE CAPAS 

// --- TOTORACOCHA ---
function style_TOTORACOCHA_1_0() {
    return { pane: 'pane_TOTORACOCHA_1', opacity: 1, color: 'rgba(35,35,35,1.0)', weight: 1.0, fill: true, fillOpacity: 1, fillColor: '#BDBEBF', interactive: true };
}
map.createPane('pane_TOTORACOCHA_1');
map.getPane('pane_TOTORACOCHA_1').style.zIndex = 401;

var layer_TOTORACOCHA_1 = new L.geoJson(json_TOTORACOCHA_1, {
    interactive: true,
    dataVar: 'json_TOTORACOCHA_1',
    layerName: 'layer_TOTORACOCHA_1',
    pane: 'pane_TOTORACOCHA_1',
    // Fabri
    onEachFeature: crearGestorCapa("Totoracocha"), 
    style: style_TOTORACOCHA_1_0,
});
bounds_group.addLayer(layer_TOTORACOCHA_1);
map.addLayer(layer_TOTORACOCHA_1);


// --- PRIMERO DE MAYO ---
function style_PRIMERODEMAYO_2() {
    return { pane: 'pane_PRIMERODEMAYO_2', opacity: 1, color: 'rgba(35,35,35,1.0)', weight: 1.0, fill: true, fillOpacity: 1, fillColor: '#BDBEBF', interactive: true };
}
map.createPane('pane_PRIMERODEMAYO_2');
map.getPane('pane_PRIMERODEMAYO_2').style.zIndex = 401;

var layer_PRIMERODEMAYO_2 = new L.geoJson(json_PRIMERODEMAYO_2, {
    interactive: true,
    dataVar: 'json_PRIMERODEMAYO_2',
    layerName: 'layer_PRIMERODEMAYO_2',
    pane: 'pane_PRIMERODEMAYO_2',
    
    onEachFeature: crearGestorCapa("Primero de Mayo"), 
    style: style_PRIMERODEMAYO_2,
});
bounds_group.addLayer(layer_PRIMERODEMAYO_2);
map.addLayer(layer_PRIMERODEMAYO_2);


// --- ORDOÑEZ LASO ---
function style_ORDOEZLASO_3_0() {
    return { pane: 'pane_ORDOEZLASO_3', opacity: 1, color: 'rgba(35,35,35,1.0)', weight: 1.0, fill: true, fillOpacity: 1, fillColor: '#BDBEBF', interactive: true };
}
map.createPane('pane_ORDOEZLASO_3');
map.getPane('pane_ORDOEZLASO_3').style.zIndex = 403;

var layer_ORDOEZLASO_3 = new L.geoJson(json_ORDOEZLASO_3, {
    interactive: true,
    dataVar: 'json_ORDOEZLASO_3',
    layerName: 'layer_ORDOEZLASO_3',
    pane: 'pane_ORDOEZLASO_3',
    // Reutilizamos de nuevo:
    onEachFeature: crearGestorCapa("Ordoñez Laso"), 
    style: style_ORDOEZLASO_3_0,
});
bounds_group.addLayer(layer_ORDOEZLASO_3);
map.addLayer(layer_ORDOEZLASO_3);


// ===================
//  Buscador por CLAVE 


var __claveIndex = new Map();
function registerByClave(layer) {
  try {
    var f = layer && layer.feature;
    var clave = f && f.properties && f.properties.CLAVE;
    if (clave != null) {
      var key = String(clave).trim().toUpperCase();
      __claveIndex.set(key, layer); 
    }
  } catch(e) { /* silencio */ }
}

// Recorre  grupos GeoJSON
[
  typeof layer_TOTORACOCHA_1 !== 'undefined' ? layer_TOTORACOCHA_1 : null,
  typeof layer_PRIMERODEMAYO_2 !== 'undefined' ? layer_PRIMERODEMAYO_2 : null,
  typeof layer_ORDOEZLASO_3 !== 'undefined' ? layer_ORDOEZLASO_3 : null
].forEach(function(group){
  if (!group || typeof group.eachLayer !== 'function') return;
  group.eachLayer(registerByClave);
});

// Autocompletar
var __claveKeys = Array.from(__claveIndex.keys());

// 5 opciones 
(function wireClaveAutocomplete(){
  var input = document.getElementById('claveSearch');
  var dl    = document.getElementById('claveOptions');
  if (!input || !dl) return;

  input.addEventListener('input', function () {
    var texto = this.value.trim().toUpperCase();

    // Limpiar opciones actuales
    dl.innerHTML = '';
    if (!texto) return;   

    var count = 0;
    for (var i = 0; i < __claveKeys.length && count < 5; i++) {
      var key = __claveKeys[i];

      
      if (key.indexOf(texto) !== -1) {
        var op = document.createElement('option');
        op.value = key;
        dl.appendChild(op);
        count++;          
      }
    }
  });
})();


// centa el panel
var DEFAULT_PANEL_WIDTH = 420;
function goToClave(q) {
  if (!q) return;
  var key = String(q).trim().toUpperCase();
  var layer = __claveIndex.get(key);
  if (!layer) {
    alert('No encontré la CLAVE: ' + q);
    return;
  }

  var b = (typeof layer.getBounds === 'function') ? layer.getBounds() : null;
  if (b && b.isValid && b.isValid()) {

    var panel = document.querySelector('.ui-panel');
    var panelWidth = DEFAULT_PANEL_WIDTH;
    if (panel) {
      panelWidth = Math.max(DEFAULT_PANEL_WIDTH, panel.offsetWidth || 0);
    }

    map.fitBounds(b, {
      maxZoom: 18,
      animate: true,
      paddingTopLeft: [20, 20],
      paddingBottomRight: [panelWidth + 20, 20] 
    });

    setTimeout(function(){ layer.fire('click'); }, 250);
  } else {
    layer.fire('click');
  }
}




(function wireSearchUI(){
  var input = document.getElementById('claveSearch');
  var btn   = document.getElementById('claveGo');
  if (!input || !btn) return;

  btn.addEventListener('click', function(){
    goToClave(input.value);
  });

  input.addEventListener('keydown', function(e){
    if (e.key === 'Enter') goToClave(input.value);
  });
})();

        </script>        
    </body>
</html>
